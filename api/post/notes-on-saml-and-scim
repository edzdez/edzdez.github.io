{"metadata":{"title":"Notes on SAML and SCIM","author":"Ethan Zhang","description":"Some notes on SAML2 and SCIM that I prepared for my manager during my internship at John Deere","date":"06/11/2024","id":6},"content":"<h2>What is SAML?</h2>\n<p>The Security Assertion Markup Language (SAML) is an XML-based standard for communicating authentication information between multiple parties.\nIts most common use case is in providing federated identity and single sign-on (SSO) functionality,\nwhich allow for employees at Deere to login once with a single set of credentials and use that same identity across multiple external services.</p>\n<h2>The Standard</h2>\n<p>There are three participants in the SAML flow:</p>\n<ul>\n<li>the Identity Provider (IdP), e.g. Okta,</li>\n<li>the Subject, i.e. the user's browser, and</li>\n<li>the Service Provider (SP), e.g. Zuora, Rally, etc.</li>\n</ul>\n<p>The standard defines an XML schema for <em>assertions</em> from one party to another.\nAn assertion is made up of some metadata (e.g. who is the subject)\nand a series of <em>statements</em>, which take on one of three forms:</p>\n<ul>\n<li>Authentication (how and when did the subject authenticate)</li>\n<li>Attribute (key-value pairs representing properties of the subject, such as email address, group membership, etc)</li>\n<li>Authorization Decision (<span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span></span> is authorized to do <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi></mrow><annotation encoding=\"application/x-tex\">Y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span></span></span> on <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi></mrow><annotation encoding=\"application/x-tex\">Z</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span></span></span>)</li>\n</ul>\n<p>Additionally, the standard defines a format for metadata that describe configuration information for a service\nA service's metadata often includes information about the role of the service, the public key for verifying the assertion, and more.</p>\n<h2>The SSO Flow</h2>\n<p>These notes will focus on the redirect based flow, where the browser brokers the authentication.\nOf such flows, there are two types, depending on whether the SP or the IdP initiates the flow.</p>\n<h3>SP-Initiated</h3>\n<ol>\n<li>Subject requests a resource from the SP.</li>\n<li>SP checks if browser has as security context:\nIf yes, skip to 7.\nElse, redirect with a <code>GET</code> to IdP with two query parameters:\n<ul>\n<li><code>SamlRequest</code>: Base64 encoded XML</li>\n<li><code>RelayState</code>: any state that needs to be kept track of, e.g. deep links</li>\n</ul>\n</li>\n<li>IdP checks if browser has a security context.\nIf not, prompt user for credentials.</li>\n<li>IdP generates a SAML assertion and puts it in an xhtml document as a hidden form.\nSign the assertion with private key and redirect with a <code>POST</code> to SP.\nEcho the <code>RelayState</code> back to the SP.</li>\n<li>SP verifies the authenticity of the assertion with IdP's public key.\nIf valid, SP generates a security context and forwards it to the subject.</li>\n<li>Subject requests the resource again.</li>\n<li>SP checks security context to see if user is authorized to access resource.\nIf yes, responds with the resource.</li>\n</ol>\n<p>It is important to note that this process is stateless, hence the <code>RelayState</code> query parameter must be used to keep track of information we want to persist.</p>\n<h3>IdP-Initiated</h3>\n<ol>\n<li>IdP prompts users for credentials.</li>\n<li>User selects service from IdP portal.</li>\n<li>IdP generates a SAML assertion and puts it in an xhtml document as a hidden form.\nSign the assertion with private key and redirect with a <code>POST</code> to SP.</li>\n<li>SP verifies the authenticity of the assertion with IdP's public key.\nIf valid, SP generates a security context and forwards it to the subject.</li>\n<li>SP checks security context to see if user is authorized to access resource.\nIf yes, responds with the resource.</li>\n</ol>\n<h2>What is SCIM?</h2>\n<p>The System for Cross-domain Identity Management (SCIM) is an open standard for provisioning users and groups across applications.</p>\n<p>For example, suppose that we want to provide access to an application for all members of a particular AD group and automatically assign each user to different permission groups based on their position in the company.\nNow, say that someone has left the team and we want to revoke access to their account.</p>\n<p>All these identity management tasks are effortless in services that support the SCIM standard.</p>\n<h2>The Standard</h2>\n<p>The SCIM standard defines two things:</p>\n<ul>\n<li>a JSON schema for representing users and groups, and</li>\n<li>a RESTful API to perform CRUD (Create, Read, Update, and Delete) operations on users and groups.</li>\n</ul>\n<h2>Example User Lifecycle</h2>\n<p>Suppose that John joins your company as a software engineer in the sales department.\nYour company uses Microsoft Active Directory (AD) as a centralized user store integrated with Okta, which you use for identity management.</p>\n<p>An example flow for how Okta may provision John's user in your favorite SaaS might be (disclaimer: I don't actually know exactly what Okta does, but this is my best guess from reading the docs):</p>\n<ol>\n<li>John's account is created in AD and assigned to the <code>Sales</code> and <code>Developer</code> AD groups.</li>\n<li>John's account information is synced to Okta, which uses the <code>Sales</code> group to assign him to <code>SaaS.com</code> and pushes the <code>Developer</code> group to the application.</li>\n<li>Okta notices that John's account does not exist on <code>SaaS.com</code>, so it issues the following <code>POST</code> request to <code>https://SaaS.com/scim/v2/Users</code>:\n<div class=\"remark-highlight\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"schemas\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"urn:ietf:params:scim:schemas:core:2.0:User\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"userName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DoeJohn@company.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"givenName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"familyName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Doe\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"emails\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"primary\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DoeJohn@company.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"work\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"displayName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"John Doe\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"locale\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"en-US\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"externalId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"randomid123\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"groups\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Developer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"password123\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"active\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\nto which <code>SaaS.com</code> responds with a <code>201 Created</code> and the newly created user.</li>\n<li>John gets promoted to a manager and gets added to the <code>Manager</code> AD group.</li>\n<li>Okta updates his user by sending a <code>PATCH</code> request to <code>https://SaaS.com/scim/v2/Users/$theusersuuid</code>:\n<div class=\"remark-highlight\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"schemas\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"urn:ietf:params:scim:api:messages:2.0:PatchOp\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Operations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"op\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"replace\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"groups\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"Manager\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\nto which <code>SaaS.com</code> responds with a <code>200 OK</code> and the updated user.</li>\n<li>John now leaves the company.</li>\n<li>Okta deactivates his account and sends a <code>PATCH</code> request to <code>https://SaaS.com/scim/v2/Users/$theusersuuid</code> (note that Okta doesn't use the <code>DELETE</code> verb):\n<div class=\"remark-highlight\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"schemas\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"urn:ietf:params:scim:api:messages:2.0:PatchOp\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Operations\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"op\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"replace\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"active\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n</li>\n</ol>\n<h2>Sources</h2>\n<h3>SAML</h3>\n<ul>\n<li><a href=\"https://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html\">https://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-tech-overview-2.0-cd-02.html</a></li>\n<li><a href=\"https://developer.okta.com/docs/concepts/saml/\">https://developer.okta.com/docs/concepts/saml/</a></li>\n<li><a href=\"https://www.samltool.com/generic_sso_res.php\">https://www.samltool.com/generic_sso_res.php</a></li>\n</ul>\n<h3>SCIM</h3>\n<ul>\n<li><a href=\"https://scim.cloud/\">https://scim.cloud/</a></li>\n<li><a href=\"https://developer.okta.com/docs/concepts/scim/\">https://developer.okta.com/docs/concepts/scim/</a></li>\n<li><a href=\"https://developer.okta.com/docs/reference/scim/scim-20/\">https://developer.okta.com/docs/reference/scim/scim-20/</a></li>\n</ul>"}