{"metadata":{"title":"Thinkpad Z16 Fan Control with Thinkfan","author":"Ethan Zhang","description":"Setting up fan control for my Thinkpad Z16","date":"07/13/2023","id":3},"content":"<blockquote>\n<p><strong><em>NOTE:</em></strong> This is how I configured <code>thinkfan</code> for my Thinkpad Z16 Gen 1 on Fedora 38.\nI don't guarantee that this'll work for any other machine.</p>\n</blockquote>\n<h2>Setup</h2>\n<ol>\n<li>\n<p>Enable fan control.\nAs root:</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"options thinkpad_acpi fan_control=1\"</span> <span class=\"token operator\">></span> /etc/modprobe.d/thinkfan.conf\n$ modprobe thinkpad_acpi\n</code></pre></div>\n<p>And reboot.</p>\n</li>\n<li>\n<p>Build <a href=\"https://github.com/vmatare/thinkfan\"><code>thinkfan</code></a> from source by following the instructions in <a href=\"https://github.com/vmatare/thinkfan/blob/master/README.md\">the README</a>.\nAt the time of writing:</p>\n<ol>\n<li>Install dependencies:\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> cmake g++ pkgconfig yaml-cpp-devel lm_sensors-devel\n</code></pre></div>\n</li>\n<li>Create a build folder:\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">mkdir</span> build <span class=\"token operator\">&#x26;&#x26;</span> <span class=\"token builtin class-name\">cd</span> build\n</code></pre></div>\n</li>\n<li>Configure the build directory (make sure <code>USE_LM_SENSORS</code> and <code>USE_YAML</code> are set to <code>ON</code>):\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ ccmake <span class=\"token punctuation\">..</span>\n</code></pre></div>\n</li>\n<li>Compile\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">make</span>\n</code></pre></div>\n</li>\n<li>And Install\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">make</span> <span class=\"token function\">install</span>\n</code></pre></div>\n</li>\n</ol>\n</li>\n<li>\n<p>Create the config:</p>\n<ol>\n<li>Run <code>sensors-detect</code> and <code>sensors</code> to find the correct name for the sensors.\nIn my case, running <code>sensors</code> produced an output of:\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\">thinkpad<span class=\"token punctuation\">-</span>isa<span class=\"token punctuation\">-</span><span class=\"token number\">0000</span>\n<span class=\"token key atrule\">Adapter</span><span class=\"token punctuation\">:</span> ISA adapter\n<span class=\"token key atrule\">fan1</span><span class=\"token punctuation\">:</span>        2364 RPM\n<span class=\"token key atrule\">fan2</span><span class=\"token punctuation\">:</span>        2219 RPM\n<span class=\"token key atrule\">CPU</span><span class=\"token punctuation\">:</span>          +44.0°C\n<span class=\"token key atrule\">GPU</span><span class=\"token punctuation\">:</span>              N/A\n<span class=\"token key atrule\">temp3</span><span class=\"token punctuation\">:</span>        +44.0°C\n<span class=\"token key atrule\">temp4</span><span class=\"token punctuation\">:</span>        +44.0°C\n<span class=\"token punctuation\">...</span>\n</code></pre></div>\n</li>\n<li>Note the names of all sensors shown, as well as the ids.\nIn this case, that would be <code>thinkpad-isa-0000</code> and <code>[ CPU, temp3, temp4, etc. ]</code>.</li>\n<li>Create <code>/etc/thinkfan.conf</code> and enter that info under <code>sensors:</code>\n(I'll show my full configuration further down).</li>\n<li>Add a section <code>fans:</code> and add <code>tpacpi: /proc/acpi/ibm/fan</code>.</li>\n<li>Add a section <code>levels:</code> and put in fan levels in the format <code>[ &#x3C;fan_level>, &#x3C;lower_limit_temp>, &#x3C;upper_limit_temp> ]</code>.\nFor example, if I wanted to set fan <code>level 4</code> from 55°C to 64°C, you would write <code>[ 4, 55, 64 ]</code>.</li>\n</ol>\n<p>My full config looks like this:</p>\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">sensors</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">chip</span><span class=\"token punctuation\">:</span> thinkpad<span class=\"token punctuation\">-</span>isa<span class=\"token punctuation\">-</span><span class=\"token number\">0000</span>\n    <span class=\"token key atrule\">ids</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> CPU<span class=\"token punctuation\">,</span> temp3<span class=\"token punctuation\">,</span> temp5<span class=\"token punctuation\">,</span> temp6<span class=\"token punctuation\">,</span> temp7 <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">chip</span><span class=\"token punctuation\">:</span> amdgpu<span class=\"token punctuation\">-</span>pci<span class=\"token punctuation\">-</span><span class=\"token number\">6400</span>\n    <span class=\"token key atrule\">ids</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> edge <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">chip</span><span class=\"token punctuation\">:</span> nvme<span class=\"token punctuation\">-</span>pci<span class=\"token punctuation\">-</span><span class=\"token number\">0300</span>\n    <span class=\"token key atrule\">ids</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> Composite <span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">fans</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">tpacpi</span><span class=\"token punctuation\">:</span> /proc/acpi/ibm/fan\n\n<span class=\"token comment\"># levels from https://wiki.gentoo.org/wiki/Fan_speed_control/thinkfan</span>\n<span class=\"token key atrule\">levels</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token number\">41</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">38</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">56</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">51</span><span class=\"token punctuation\">,</span> <span class=\"token number\">61</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token number\">66</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">63</span><span class=\"token punctuation\">,</span> <span class=\"token number\">68</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">74</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"level full-speed\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">70</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32767</span> <span class=\"token punctuation\">]</span>\n</code></pre></div>\n</li>\n<li>\n<p>Run <code>thinkfan</code> to test your configuration.</p>\n</li>\n<li>\n<p>Enable the <code>systemd</code> service:</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">sudo</span> systemctl <span class=\"token builtin class-name\">enable</span> thinkfan\n</code></pre></div>\n</li>\n</ol>\n<h2>Why Did I Build From Source?</h2>\n<p>The version of <code>thinkfan</code> in the fedora repos seems to be built without <code>lm_sensors</code> support.\nAs such, if you did <code>sudo dnf install thinkfan</code> and tried to run my configuration, you'd get this rather cryptic error message:</p>\n<div class=\"remark-highlight\"><pre class=\"language-unknown\"><code class=\"language-unknown\">ERROR: /etc/thinkfan.yaml:2:\n  - chip: thinkpad-isa-0000\n    ^\nInvalid sensor entry.</code></pre></div>\n<p>(See <a href=\"https://github.com/vmatare/thinkfan/issues/229\">this issue</a>, which is still applicable despite being about the AUR package).</p>\n<h2>Fan Speeds</h2>\n<p>Thinkpads' have eight fan speed levels (<a href=\"https://www.thinkwiki.org/wiki/How_to_control_fan_speed\">https://www.thinkwiki.org/wiki/How_to_control_fan_speed</a>):</p>\n<ul>\n<li><code>level 0</code>: fans off</li>\n<li><code>level 1</code></li>\n<li><code>level 2</code>: low speed</li>\n<li><code>level 3</code></li>\n<li><code>level 4</code>: medium speed</li>\n<li><code>level 5</code></li>\n<li><code>level 6</code></li>\n<li><code>level 7</code>: high speed</li>\n</ul>\n<p>And three special levels (<a href=\"https://wiki.gentoo.org/wiki/Fan_speed_control/thinkfan\">https://wiki.gentoo.org/wiki/Fan_speed_control/thinkfan</a>):</p>\n<ul>\n<li><code>level auto</code>: the default level where fan RPM is controlled by the BIOS</li>\n<li><code>level full-speed</code>: the maximum monitored speed</li>\n<li><code>level disengaged</code>: the true maximum speed where the embedded controller stops monitoring the fan speed</li>\n</ul>\n<h2>Manual Fan Speed Control</h2>\n<p>To control fan speed manually, just <code>echo</code> the intended level to <code>/proc/acpi/ibm/fan</code>.\nFor example, to change the fan speed to <code>level 4</code>, run:</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"level 4\"</span> <span class=\"token operator\">></span> /proc/acpi/ibm/fan\n</code></pre></div>"}